stages:
  - mirror
  - update

mirror_to_github:
  stage: mirror
  image: alpine:latest
  before_script:
    - apk add --no-cache git curl openssh-client
  script:
    - git config --global user.email "titouan336@users.noreply.github.com"
    - git config --global user.name "Titouan336 Mirror Bot"
    - git remote remove mirror || true
    - git remote add mirror https://oauth2:$GITHUB_TOKEN@github.com/titouan336/Spotify-AltStoreRepo-mirror.git
    - git checkout $CI_COMMIT_REF_NAME
    - rm -f .gitignore
    - echo "ipas/" > .gitignore
    - git rm -r --cached ipas/ || true
    - git add source.json .gitignore || true
    - git commit --allow-empty -m "ðŸ¤– Mirror clean $(date)" || true
    - git push mirror $CI_COMMIT_REF_NAME --force
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'

spotify_update:
  image: python:3.12-alpine
  stage: update
  script:
    - apk add --no-cache git
    - pip install python-telegram-bot requests
    - python3 scripts/scan_telegram.py
    - python3 scripts/push_gitlab.py
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule" && $CI_COMMIT_BRANCH == "main"'